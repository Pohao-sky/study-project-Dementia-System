<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Trail Making Test A - Demo</title>
  <style>
    body { background: #f7f7f7; }
    #tmt-canvas { background: #fff; border: 2px solid #333; display: block; margin: 40px auto; }
    .tmt-restart { display: block; margin: 20px auto; font-size: 16px; }
    #timer-area {
      text-align: center; font-size: 22px; margin-top: 28px; margin-bottom: 5px;
    }
    #timer-area span { margin: 0 18px; font-weight: bold; color: #1e50a2; }
    #popup {
      position: fixed;
      left: 50%; top: 32%;
      transform: translate(-50%, -50%);
      background: #fff9e7;
      border: 2.5px solid #e9742b;
      border-radius: 15px;
      box-shadow: 0 6px 32px #e9742b44;
      padding: 32px 32px 16px 32px;
      font-size: 23px;
      color: #c44707;
      text-align: center;
      z-index: 10000;
      min-width: 270px;
      display: none;
      animation: popupIn .2s cubic-bezier(.55,1.6,.31,1);
    }
    @keyframes popupIn {
      0% { transform: translate(-50%,-60%) scale(.8); opacity:.5; }
      100% { transform: translate(-50%,-50%) scale(1); opacity:1; }
    }
    #popup-btn {
      margin-top: 18px;
      padding: 8px 28px;
      border-radius: 7px;
      border: none;
      font-size: 17px;
      background: #e9742b;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px #e9742b33;
      transition: background .2s;
    }
    #popup-btn:hover { background: #c44707; }
  </style>
</head>
<body>
  <div id="timer-area">
    <span id="tmt-timer">0.0</span>秒　
    ｜錯誤次數：<span id="tmt-errors">0</span>
  </div>
  <canvas id="tmt-canvas" width="700" height="500"></canvas>
  <div id="popup">
    <div id="popup-msg"></div>
    <button id="popup-btn" onclick="hidePopup()">確定</button>
  </div>
<script>
const canvas = document.getElementById('tmt-canvas');
const ctx = canvas.getContext('2d');
const N = 24;
const RADIUS = 22;
const nodes = [];
const lines = [];
let dragging = false;
let lastNode = null;
let currentPath = [];
let startTime = null, endTime = null;
let timerInterval = null;
let errorCount = 0;
let started = false;

function updateTimerDisplay() {
  const el = document.getElementById('tmt-timer');
  if (startTime && !endTime) {
    el.textContent = ((Date.now() - startTime) / 1000).toFixed(1);
  } else if (startTime && endTime) {
    el.textContent = ((endTime - startTime) / 1000).toFixed(1);
  } else {
    el.textContent = "0.0";
  }
}
function updateErrorDisplay() {
  document.getElementById('tmt-errors').textContent = errorCount;
}

function showPopup(msg) {
  document.getElementById('popup-msg').textContent = msg;
  document.getElementById('popup').style.display = 'block';
  document.body.style.pointerEvents = 'none';
  document.getElementById('popup').style.pointerEvents = 'auto';
}
function hidePopup() {
  document.getElementById('popup').style.display = 'none';
  document.body.style.pointerEvents = 'auto';
}

// 隨機產生不重疊的座標
function randomNodes(n) {
  const arr = [];
  let count = 0;
  while(arr.length < n && count < 3000) {
    let x = Math.random() * (canvas.width - RADIUS * 2) + RADIUS;
    let y = Math.random() * (canvas.height - RADIUS * 2) + RADIUS;
    if(arr.every(pt => (pt.x - x)**2 + (pt.y - y)**2 > RADIUS*2.8*RADIUS*2.8)) {
      arr.push({x, y});
    }
    count++;
  }
  return arr;
}
// 初始化節點，編號隨機
function setupNodes() {
  let coords = randomNodes(N);
  let nums = Array.from({length:N}, (_,i)=>i+1);
  nums.sort(()=>Math.random()-0.5);
  for(let i=0;i<N;i++){
    nodes.push({num:nums[i], x:coords[i].x, y:coords[i].y});
  }
  nodes.sort((a,b)=>a.num-b.num);
}

function drawAll() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.lineWidth = 4;
  ctx.strokeStyle = "#2186f6";
  lines.forEach(l=>{
    ctx.beginPath();
    ctx.moveTo(l.from.x, l.from.y);
    ctx.lineTo(l.to.x, l.to.y);
    ctx.stroke();
  });
  ctx.restore();
  nodes.forEach((n, i) => {
    ctx.beginPath();
    ctx.arc(n.x, n.y, RADIUS, 0, Math.PI*2);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.lineWidth = 2.2;
    ctx.strokeStyle = "#222";
    ctx.stroke();
    ctx.fillStyle = "#222";
    ctx.font = "18px bold sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(n.num, n.x, n.y);
  });
  if(dragging && lastNode && currentPath.length > 0) {
    ctx.save();
    ctx.strokeStyle = "#ff8800";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(lastNode.x, lastNode.y);
    ctx.lineTo(currentPath[0], currentPath[1]);
    ctx.stroke();
    ctx.restore();
  }
}

function getNodeAt(x, y) {
  for(let i=0;i<nodes.length;i++){
    let n = nodes[i];
    if((n.x-x)**2 + (n.y-y)**2 <= RADIUS*RADIUS) return n;
  }
  return null;
}

function resetTest() {
  nodes.length = 0;
  lines.length = 0;
  dragging = false;
  lastNode = null;
  currentPath = [];
  startTime = null;
  endTime = null;
  timerInterval && clearInterval(timerInterval);
  timerInterval = null;
  errorCount = 0;
  started = false;
  setupNodes();
  drawAll();
  updateTimerDisplay();
  updateErrorDisplay();
}

// 初始化：顯示提示，待用戶點擊開始
window.onload = function() {
  showPopup('請點擊下方「開始連線測驗」按鈕！');
};

// 新增開始連線測驗按鈕
const btn = document.createElement('button');
btn.textContent = '開始連線測驗';
btn.className = 'tmt-restart';
document.body.insertBefore(btn, document.getElementById('popup'));
btn.onclick = () => {
  resetTest();
  hidePopup();
  btn.style.display = 'none';
  started = true;
  // 這裡就開始計時！
  startTime = Date.now();
  timerInterval = setInterval(updateTimerDisplay, 100);
  updateTimerDisplay();
};

drawAll();
updateTimerDisplay();
updateErrorDisplay();

canvas.addEventListener('mousedown', (e)=>{
  if (!started) return;
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  let node = getNodeAt(mx, my);
  if(!node) return;
  if(lines.length===0 && node.num===1) {
    dragging = true;
    lastNode = node;
    // 移除 startTime 這一段，已改為按下開始時啟動
  }
  else if(lines.length>0 && node.num === lines.length+1) {
    dragging = true;
    lastNode = node;
  }
  drawAll();
});

canvas.addEventListener('mousemove', (e)=>{
  if(!dragging || !lastNode) return;
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  currentPath = [mx, my];
  drawAll();
});

canvas.addEventListener('mouseup', (e)=>{
  if(!dragging || !lastNode) return;
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  let next = getNodeAt(mx, my);
  let expectedNum = (lines.length+2);
  if(next && next.num === expectedNum && next !== lastNode) {
    lines.push({from:lastNode, to:next});
    lastNode = next;
    if(next.num===N) {
      dragging = false;
      endTime = Date.now();
      updateTimerDisplay();
      clearInterval(timerInterval);
      setTimeout(()=>{
        showPopup("完成！總花費時間：" + ((endTime-startTime)/1000).toFixed(1) + " 秒\n錯誤次數：" + errorCount);
      }, 100);
    }
  } else if(next && next !== lastNode) {
    errorCount += 1;
    updateErrorDisplay();
    showPopup(`你剛連到 ${lastNode.num}，下一個數字是什麼？`);
  }
  dragging = false;
  currentPath = [];
  drawAll();
});
</script>
</body>
</html>
